#define _POSIX_C_SOURCE 200809L
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>
#include <sys/socket.h>
#include <netinet/in.h> //–°–µ—Ç–µ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.
#include <errno.h> //n–∞–∫–∂–µ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —è–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å errno == EINTR (–∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ –ø–æ—Å–ª–µ pselect).

#include <string.h>
#include <sys/select.h> 

static volatile sig_atomic_t got_sighup = 0; //got_sighup ‚Äî —Ñ–ª–∞–≥, –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–º–µ–Ω—è–µ–º—ã–π –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–∏–≥–Ω–∞–ª–∞ (—Ç–∏–ø sig_atomic_t –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å).

void sighup_handler(int sig) { //–û–±—Ä–∞–±–æ—Ç—á–∏–∫ sighup_handler —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ SIGHUP –∏ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥
    (void)sig;
    got_sighup = 1;
}

int main() {
    int listen_fd = socket(AF_INET, SOCK_STREAM, 0); //–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Å–æ–∫–µ—Ç ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.
    //AF_INET ‚Äî —Å–µ–º–µ–π—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤ IPv4. SOCK_STREAM ‚Äî —Ç–∏–ø —Å–æ–∫–µ—Ç–∞: –Ω–∞–¥—ë–∂–Ω—ã–π, –ø–æ—Ç–æ–∫–æ–≤—ã–π, —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (TCP). 0 ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
    if (listen_fd == -1) {
        perror("socket");
        exit(1);
    }

    int yes = 1; //—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–∫–∞–∑–∞—Ç—å "–≤–∫–ª—é—á–∏—Ç—å" –æ–ø—Ü–∏—é –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö POSIX.
    setsockopt(listen_fd, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(yes)); //–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–ø—Ü–∏—é —Å–æ–∫–µ—Ç–∞. /–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: listen_fd ‚Äî –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞. SOL_SOCKET ‚Äî —É—Ä–æ–≤–µ–Ω—å –æ–ø—Ü–∏–π: –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö —Å–æ–∫–µ—Ç–æ–≤ (–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø—Ä–æ—Ç–æ–∫–æ–ª—É). SO_REUSEADDR ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ (IP:–ø–æ—Ä—Ç) —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞.
//–ë–µ–∑ —ç—Ç–æ–≥–æ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –Ω–∞ —Ç–æ–º –∂–µ –ø–æ—Ä—Ç—É –≤ —Ç–µ—á–µ–Ω–∏–µ ~30‚Äì120 —Å–µ–∫—É–Ω–¥ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ TIME_WAIT –≤ TCP). &yes ‚Äî —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ (1 = –≤–∫–ª—é—á–∏—Ç—å). sizeof(yes) ‚Äî —Ä–∞–∑–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ 4 –±–∞–π—Ç–∞).
// –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —Å—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤–æ–∑–≤—Ä–∞—Ç setsockopt(), –Ω–æ –≤ —É—á–µ–±–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö —á–∞—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç.
    struct sockaddr_in addr = {0}; //–û–±—ä—è–≤–ª—è–µ—Ç –∏ –æ–±–Ω—É–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É sockaddr_in ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è IPv4-–∞–¥—Ä–µ—Å–∞ –∏ –ø–æ—Ä—Ç–∞ /{} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ª—è –Ω—É–ª—è–º
    addr.sin_family = AF_INET; //–£–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ–º–µ–π—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤: IPv4.
    addr.sin_port = htons(12345); //TT—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —á–∏—Å–ª–æ –∏–∑ –ø–æ—Ä—è–¥–∫–∞ –±–∞–π—Ç–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (host byte order) –≤ —Å–µ—Ç–µ–≤–æ–π –ø–æ—Ä—è–¥–æ–∫
    addr.sin_addr.s_addr = htonl(INADDR_LOOPBACK); // –∑–∞–¥–∞–µ—Ç IP –∞–¥—Ä–µ—Å / htonl –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç 32-–±–∏—Ç–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å–µ—Ç–µ–≤–æ–π –ø–æ—Ä—è–¥–æ–∫ –±–∞–π—Ç–æ–≤.

    if (bind(listen_fd, (struct sockaddr*)&addr, sizeof(addr)) == -1) {
        perror("bind");
        close(listen_fd);
        exit(1);
    }

    if (listen(listen_fd, 5) == -1) { //–ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–æ–∫–µ—Ç –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π listen_fd ‚Äî –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞.
//5 ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
        perror("listen");
        close(listen_fd);
        exit(1);
    }

    struct sigaction sa = {0}; //–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —á–µ—Ä–µ–∑ sigaction (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ, —á–µ–º signal)
    sa.sa_handler = sighup_handler;
    sa.sa_flags = SA_RESTART; //–§–ª–∞–≥ SA_RESTART ‚Äî –ø—Ä–æ—Å–∏—Ç —è–¥—Ä–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, accept, recv), 
    //–µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ—Ä–≤–∞–Ω—ã –Ω–µ —ç—Ç–∏–º —Å–∏–≥–Ω–∞–ª–æ–º. –û–¥–Ω–∞–∫–æ –∑–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è pselect, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –∏ —ç—Ç–æ –≤–∞–∂–Ω–æ.
    sigemptyset(&sa.sa_mask);
    if (sigaction(SIGHUP, &sa, NULL) == -1) {
        perror("sigaction");
        close(listen_fd);
        exit(1);
    }

    sigset_t blocked_mask, orig_mask; //–ü–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª SIGHUP –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–∞—Ö (–ø—Ä–æ—Ü–µ—Å—Å–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π).
//–≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –æ—Ç–ª–æ–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–∞ –¥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ ‚Äî –∏–º–µ–Ω–Ω–æ –≤ pselect()
    sigemptyset(&blocked_mask);
    sigaddset(&blocked_mask, SIGHUP);
    if (sigprocmask(SIG_BLOCK, &blocked_mask, &orig_mask) == -1) {
        perror("sigprocmask");
        close(listen_fd);
        exit(1);
    }

    int client_fd = -1;    //–ó–Ω–∞—á–µ–Ω–∏–µ -1 ‚Äî –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä, –ø–æ—ç—Ç–æ–º—É –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–∞–∫ –º–∞—Ä–∫–µ—Ä "–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞".
    const int MAX_BUF = 256; //–≠—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞.
    char buf[MAX_BUF]; //–≠—Ç–æ –±—É—Ñ–µ—Ä –≤–≤–æ–¥–∞: –≤ –Ω–µ–≥–æ —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏—à–µ–¥—à–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ TCP.

    printf("Server started on 127.0.0.1:12345. Waiting for connections...\n");

    while (1) {
        fd_set read_fds;   // —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –±–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è select/pselect –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤.
        FD_ZERO(&read_fds); //–æ–±–Ω—É–ª—è–µ—Ç –º–∞—Å–∫—É (–≤—Å–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã "–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è")
        FD_SET(listen_fd, &read_fds); //–¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª—É—à–∞—é—â–∏–π —Å–æ–∫–µ—Ç –≤ –Ω–∞–±–æ—Ä: "—Å–æ–æ–±—â–∏, –∫–æ–≥–¥–∞ –ø—Ä–∏–¥—É—Ç –Ω–æ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è".
        int max_fd = listen_fd; //–∑–∞–ø–æ–º–∏–Ω–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä (–Ω—É–∂–Ω–æ –¥–ª—è pselect).

        if (client_fd != -1) {   //–ï—Å–ª–∏ **–µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∏–µ–Ω—Ç** (`client_fd != -1`),  –û.
            FD_SET(client_fd, &read_fds);  //–î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –≤ –Ω–∞–±–æ—Ä: "—Å–æ–æ–±—â–∏, –∫–æ–≥–¥–∞ –ø—Ä–∏–¥—É—Ç –¥–∞–Ω–Ω—ã–µ
            if (client_fd > max_fd) max_fd = client_fd; //0–±–Ω–æ–≤–ª—è–µ–º `max_fd`, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –±–æ–ª—å—à–µ (–æ–±—ã—á–Ω–æ —Ç–∞–∫ –∏ –µ—Å—Ç—å)
        }

        int ready = pselect(max_fd + 1, &read_fds, NULL, NULL, NULL, &orig_mask);  //max_fd + 1 ‚Äî –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤. &read_fds ‚Äî –Ω–∞–±–æ—Ä –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –Ω–∞ —á—Ç–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.
//–û—Å—Ç–∞–ª—å–Ω—ã–µ NULL ‚Äî –Ω–µ –∂–¥—ë–º –∑–∞–ø–∏—Å—å, –æ—à–∏–±–∫–∏, —Ç–∞–π–º–∞—É—Ç.
//&orig_mask ‚Äî –º–∞—Å–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –Ω–∞ –≤—Ä–µ–º—è –≤—ã–∑–æ–≤–∞.
//üî• –ó–∞—á–µ–º &orig_mask?
//–†–∞–Ω–µ–µ –≤—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ SIGHUP —á–µ—Ä–µ–∑ sigprocmask(SIG_BLOCK, ...).
//pselect() –∞—Ç–æ–º–∞—Ä–Ω–æ:
// —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞—Å–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ orig_mask (—Ç.–µ. —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç SIGHUP),
// –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–ø—è—â–∏–π —Ä–µ–∂–∏–º, –æ–∂–∏–¥–∞—è —Å–æ–±—ã—Ç–∏–π,
// –ø–æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—É—é –º–∞—Å–∫—É (—Å–Ω–æ–≤–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç SIGHUP).
// –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition: —Å–∏–≥–Ω–∞–ª –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ "–º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–ª–∞–≥–∞ –∏ –≤—Ö–æ–¥–æ–º –≤ pselect".
        if (ready == -1) {
            if (errno == EINTR) {
                if (got_sighup) {
                    printf("Received SIGHUP\n");
                    got_sighup = 0; 
                }
                continue;
            } else {
                perror("pselect");
                break;
            }
        }

        if (FD_ISSET(listen_fd, &read_fds)) {
            struct sockaddr_in cli_addr;
            socklen_t cli_len = sizeof(cli_addr);
            int new_fd = accept(listen_fd, (struct sockaddr*)&cli_addr, &cli_len);
            if (new_fd == -1) {
                perror("accept");
                continue;
            }

            if (client_fd == -1) {
                client_fd = new_fd;
                printf("Accepted connection (fd=%d)\n", client_fd);
            } else {
                close(new_fd);
            }
        }

        if (client_fd != -1 && FD_ISSET(client_fd, &read_fds)) {
            ssize_t n = recv(client_fd, buf, MAX_BUF, 0);
            if (n > 0) {
                printf("Received %zd bytes from client\n", n);
            } else if (n == 0) {
                printf("Client closed connection\n");
                close(client_fd);
                client_fd = -1;
            } else {
                    perror("recv");
                    close(client_fd);
                    client_fd = -1;
            }
        }
    }

    if (client_fd != -1) close(client_fd);
    close(listen_fd);
    return 0;
}